# GitHub Integration Guide

Complete guide to using GitHub integration in Bricker for version-controlled data models and templates.

## Overview

Bricker integrates with GitHub to store your data models and templates as YAML files in a version-controlled repository. This enables:

- **Version Control**: Track changes to your data models over time
- **Collaboration**: Share models with team members via Git
- **Backup**: Automatic backup of all models in GitHub
- **Portability**: Export models as standard YAML files
- **CI/CD Integration**: Use GitHub Actions to automate model deployment

## Setup

### 1. Create a GitHub Repository

1. Go to [GitHub](https://github.com) and create a new repository
2. Name it something like `bricker-metadata` or `databricks-models`
3. Make it **private** (recommended) or public
4. Initialize with a README (optional)

### 2. Create a Personal Access Token

1. Go to GitHub Settings > Developer settings > [Personal Access Tokens](https://github.com/settings/tokens)
2. Click **"Generate new token (classic)"**
3. Give it a descriptive name: `Bricker Integration`
4. Select scopes:
   - ✅ **repo** (full control of private repositories)
5. Click **"Generate token"**
6. **Copy the token immediately** (you won't see it again!)

### 3. Connect GitHub in Bricker

1. In Bricker, click the **Settings** icon (top-right)
2. Go to the **GitHub Integration** tab
3. Fill in the form:
   - **Repository**: `username/repository-name` (e.g., `acme/bricker-metadata`)
   - **Personal Access Token**: Paste your token
   - **Branch**: `main` (or your preferred branch)
4. Click **"Connect to GitHub"**
5. You should see a success message with repository details

## Repository Structure

Once connected, Bricker will create the following structure in your repository:

```
your-repository/
├── metadata/
│   ├── models/                 # Data models
│   │   ├── model_001.yaml
│   │   ├── model_002.yaml
│   │   └── ...
│   ├── templates/              # Templates by category
│   │   ├── ddl/
│   │   │   ├── create_table.yaml
│   │   │   └── alter_table.yaml
│   │   ├── etl/
│   │   │   ├── incremental_load.yaml
│   │   │   └── full_refresh.yaml
│   │   └── ...
│   └── configurations/         # Workspace configurations
│       ├── workspace_001.yaml
│       └── ...
└── README.md
```

## Exporting Models to GitHub

### Export from Canvas

1. Design your data model on the React Flow canvas
2. Click the **GitHub icon** (dark button, top-right of canvas)
3. The model will be exported to `metadata/models/{model_id}.yaml`
4. A commit will be created with message: `Create/Update data model: {model_name}`

### Manual Export

You can also export models using the API:

```typescript
import { githubApi } from '@/api/github';

await githubApi.exportModel(workspaceId, {
  id: 'model_001',
  name: 'Customer Dimension',
  model_type: 'dimensional',
  version: 1,
  created_at: new Date().toISOString(),
  updated_at: new Date().toISOString(),
  nodes: [...],
  edges: [...],
});
```

## YAML Format

### Data Model YAML

```yaml
# Data Model: Customer Dimension
# Generated by Bricker - Databricks Automation Builder
# Model ID: model_001

id: "model_001"
name: "Customer Dimension"
description: "Type 2 SCD for customer data"
model_type: dimensional
version: 1
created_at: "2025-10-02T10:30:00Z"
updated_at: "2025-10-02T10:30:00Z"

# Nodes (Tables, Transformations, etc.)
nodes:
  - id: "node_001"
    type: "dimension"
    position:
      x: 100
      y: 100
    data:
      table_name: "dim_customer"
      catalog: "main"
      schema: "analytics"
      columns:
        - name: "customer_sk"
          type: "BIGINT"
          primary_key: true
        - name: "customer_id"
          type: "STRING"
          business_key: true
        - name: "customer_name"
          type: "STRING"
        - name: "effective_date"
          type: "DATE"
        - name: "end_date"
          type: "DATE"
        - name: "is_current"
          type: "BOOLEAN"
      optimizations:
        liquid_clustering: ["customer_id"]
        partition_by: ["effective_date"]

# Edges (Data Flow)
edges:
  - id: "edge_001"
    source: "node_source"
    target: "node_001"

# Metadata
metadata:
  workspace_id: "workspace_123"
  workspace_name: "Production Workspace"
```

### Template YAML

```yaml
# Template: Create Delta Table
# Category: ddl
# Language: sql

id: "template_001"
name: "Create Delta Table"
description: "Create a Delta table with optimizations"
category: ddl
language: sql

# Variables
variables:
  - name: "catalog"
    type: string
    required: true
    description: "Unity Catalog name"
  - name: "schema"
    type: string
    required: true
    description: "Schema name"
  - name: "table_name"
    type: string
    required: true
    description: "Table name"
  - name: "columns"
    type: array
    required: true
    description: "List of column definitions"

# Template Content
template_content: |
  CREATE TABLE IF NOT EXISTS {{ catalog }}.{{ schema }}.{{ table_name }} (
    {% for column in columns %}
    {{ column.name }} {{ column.type }}{% if not loop.last %},{% endif %}
    {% endfor %}
  )
  USING DELTA
  {% if liquid_clustering %}
  CLUSTER BY ({{ liquid_clustering | join(', ') }})
  {% endif %}
  {% if partition_by %}
  PARTITIONED BY ({{ partition_by | join(', ') }})
  {% endif %}
  TBLPROPERTIES (
    'delta.enableChangeDataFeed' = 'true',
    'delta.enableDeletionVectors' = 'true'
  );
```

## Importing Models from GitHub

### Import via UI

1. Go to Settings > GitHub Integration
2. Click **"Browse Models"** (coming soon)
3. Select a model from the list
4. Click **"Import to Canvas"**

### Import via API

```typescript
import { githubApi } from '@/api/github';

// List all models in GitHub
const models = await githubApi.listModels(workspaceId);

// Import specific model
const model = await githubApi.importModel(workspaceId, 'model_001');

// Apply to canvas
setNodes(model.nodes);
setEdges(model.edges);
```

## Branch Management

### Create a New Branch

Useful for working on experimental models without affecting main:

```typescript
await githubApi.createBranch(
  workspaceId,
  'feature/new-customer-model',
  'main'
);
```

### Switch Branches

1. Go to Settings > GitHub Integration
2. Click **"Disconnect"**
3. Reconnect with a different branch name

## Best Practices

### Naming Conventions

- **Models**: `{model_type}_{entity}_{version}.yaml`
  - Examples: `dimension_customer_v1.yaml`, `hub_product_v2.yaml`
- **Templates**: `{operation}_{object}.yaml`
  - Examples: `create_table.yaml`, `incremental_load.yaml`

### Commit Messages

Bricker automatically generates descriptive commit messages:

- Creating: `Create data model: Customer Dimension`
- Updating: `Update data model: Customer Dimension`
- Deleting: `Delete data model: model_001`

### Version Control Strategy

1. **Main Branch**: Stable, production-ready models
2. **Dev Branch**: Development and testing
3. **Feature Branches**: Experimental models

### Security

- **Never commit tokens**: Tokens are stored in workspace settings, not in YAML files
- **Use private repositories**: Keep your data models confidential
- **Rotate tokens regularly**: Change GitHub tokens every 90 days
- **Use fine-grained tokens**: Limit scope to specific repositories

## Troubleshooting

### "Failed to connect to GitHub repository"

**Causes:**
- Invalid repository name (must be `owner/repo` format)
- Token doesn't have `repo` scope
- Repository doesn't exist or you don't have access

**Solutions:**
1. Verify repository exists: Visit `https://github.com/owner/repo`
2. Check token scopes in GitHub settings
3. Ensure token hasn't expired

### "Failed to export model"

**Causes:**
- GitHub connection not configured
- Token expired or revoked
- Network issues

**Solutions:**
1. Check connection status in Settings
2. Reconnect with a fresh token
3. Verify internet connectivity

### "Model not found in GitHub"

**Causes:**
- Model hasn't been exported yet
- Wrong branch selected
- Model was deleted from GitHub

**Solutions:**
1. Export the model first using the GitHub button
2. Check you're on the correct branch
3. Verify model exists in `metadata/models/` on GitHub

## API Reference

### Connect to GitHub

```typescript
await githubApi.connect(
  workspaceId: string,
  githubRepo: string,      // "owner/repository"
  githubToken: string,     // GitHub PAT
  branch?: string          // Default: "main"
): Promise<{ success: boolean; repository: any }>
```

### Get Connection Status

```typescript
await githubApi.getConnectionStatus(
  workspaceId: string
): Promise<{
  connected: boolean;
  repository?: {
    name: string;
    fullName: string;
    description: string;
    private: boolean;
    defaultBranch: string;
    url: string;
  };
}>
```

### Export Model

```typescript
await githubApi.exportModel(
  workspaceId: string,
  model: DataModelYAML
): Promise<{
  success: boolean;
  commit_sha: string;
  message: string;
}>
```

### Import Model

```typescript
await githubApi.importModel(
  workspaceId: string,
  modelId: string
): Promise<DataModelYAML>
```

### List Models

```typescript
await githubApi.listModels(
  workspaceId: string
): Promise<Array<{
  id: string;
  name: string;
  path: string;
}>>
```

### Delete Model

```typescript
await githubApi.deleteModel(
  workspaceId: string,
  modelId: string
): Promise<void>
```

### List Branches

```typescript
await githubApi.listBranches(
  workspaceId: string
): Promise<string[]>
```

### Create Branch

```typescript
await githubApi.createBranch(
  workspaceId: string,
  branchName: string,
  fromBranch?: string  // Default: current branch
): Promise<void>
```

## Advanced Usage

### CI/CD Integration

Use GitHub Actions to validate and deploy models:

```yaml
# .github/workflows/validate-models.yml
name: Validate Data Models

on:
  push:
    paths:
      - 'metadata/models/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Validate YAML
        run: |
          for file in metadata/models/*.yaml; do
            yamllint "$file"
          done
```

### Model Versioning

Track model versions using semantic versioning:

```yaml
id: "customer_dimension_v2"
name: "Customer Dimension v2.0"
version: 2
```

### Team Collaboration

1. Each team member works on their own branch
2. Create Pull Requests to merge changes
3. Review model changes before merging to main
4. Use GitHub Issues to track model requests

## FAQ

**Q: Can I use multiple repositories for different workspaces?**
A: Yes! Each workspace can connect to a different GitHub repository.

**Q: Are my GitHub tokens encrypted?**
A: Currently tokens are stored in the workspace settings JSONB field. In production, implement encryption using Supabase's `pgcrypto` extension.

**Q: Can I import models from a different workspace?**
A: Yes, if both workspaces are connected to the same GitHub repository.

**Q: What happens if I delete a model from GitHub manually?**
A: The model will no longer be importable. Bricker doesn't sync deletions automatically.

**Q: Can I edit YAML files directly in GitHub?**
A: Yes! Edit the YAML files in GitHub and import them back into Bricker.

## Resources

- [GitHub Personal Access Tokens](https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token)
- [GitHub API Documentation](https://docs.github.com/en/rest)
- [YAML Syntax Guide](https://yaml.org/spec/1.2/spec.html)
- [Bricker YAML Schema](../ARCHITECTURE.md#yaml-metadata-structure)
